<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الاستقبال - مركز عصفور</title>
    <!-- استدعاء Bootstrap لتصميم جدول سريع وأنيق -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f4f6f9;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard-container {
            display: none;
            padding: 20px;
        }

        .status-badge {
            font-size: 0.8rem;
        }

        .table-responsive {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body>

    <!-- 1. شاشة تسجيل الدخول -->
    <div id="loginSection" class="login-container">
        <h3 class="text-center mb-4 text-primary">تسجيل دخول الموظفين</h3>
        <form id="loginForm">
            <div class="mb-3">
                <label>البريد الإلكتروني</label>
                <input type="email" id="email" class="form-control" placeholder="admin@center.com" required>
            </div>
            <div class="mb-3">
                <label>كلمة المرور</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">دخول</button>
        </form>
    </div>

    <!-- 2. لوحة التحكم (الجدول) -->
    <div id="dashboardSection" class="dashboard-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary">حجوزات اليوم</h2>
            <button onclick="logout()" class="btn btn-danger btn-sm">تسجيل خروج</button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>اسم المريض</th>
                        <th>رقم الهاتف</th>
                        <th>العيادة / الطبيب</th>
                        <th>وقت الحجز</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody id="bookingsTable">
                    <!-- البيانات ستظهر هنا -->
                </tbody>
            </table>
            <p id="loadingMsg" class="text-center text-muted">جاري تحميل البيانات...</p>
        </div>
    </div>

    <!-- كود Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- هام: ضع نفس بيانات مشروعك هنا ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7DEhZdEKyhWtMPMeQ6S6IrDB3lyxJ9DU",
  authDomain: "osretna.firebaseapp.com",
  databaseURL: "https://osretna-default-rtdb.firebaseio.com",
  projectId: "osretna",
  storageBucket: "osretna.firebasestorage.app",
  messagingSenderId: "891601757154",
  appId: "1:891601757154:web:19a8fab19ee8dc3d208fbb",
  measurementId: "G-TCB8XP9C87"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // مراقبة حالة تسجيل الدخول
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardSection').style.display = 'block';
                loadBookings();
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('dashboardSection').style.display = 'none';
            }
        });

        // دالة تسجيل الدخول
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    // سيتم التحويل تلقائياً عبر onAuthStateChanged
                })
                .catch((error) => {
                    alert("خطأ في الدخول: " + error.message);
                });
        });

        // دالة جلب البيانات (Real-time)
        function loadBookings() {
            const q = query(collection(db, "bookings"), orderBy("date", "desc")); // ترتيب بالأحدث

            // onSnapshot تعني أي تحديث يحدث لحظياً سيظهر فوراً في الجدول
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('bookingsTable');
                tbody.innerHTML = '';
                document.getElementById('loadingMsg').style.display = 'none';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">لا توجد حجوزات حتى الآن</td></tr>';
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const date = new Date(data.date).toLocaleDateString('ar-EG');
                    const time = new Date(data.date).toLocaleTimeString('ar-EG');

                    const row = `
                        <tr>
                            <td class="fw-bold">${data.patientName}</td>
                            <td><a href="tel:${data.phone}" style="text-decoration:none;">${data.phone}</a></td>
                            <td><span class="badge bg-info text-dark">${data.doctor}</span></td>
                            <td>${date} <br> <small class="text-muted">${time}</small></td>
                            <td>
                                <button onclick="window.deleteBooking('${docSnap.id}')" class="btn btn-outline-danger btn-sm">
                                    حذف (تم الكشف)
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        }

        // جعل دالة الحذف متاحة في HTML
        window.deleteBooking = async (id) => {
            if (confirm('هل أنت متأكد من حذف هذا الحجز؟ (يعني أن المريض تم الكشف عليه)')) {
                await deleteDoc(doc(db, "bookings", id));
            }
        };

        // دالة الخروج
        window.logout = () => {
            signOut(auth);
        };
    </script>
</body>


</html>
