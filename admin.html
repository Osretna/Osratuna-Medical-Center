<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المركز الطبي عصفور</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #e9ecef;
        }

        .login-box {
            max-width: 400px;
            margin: 80px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dashboard {
            display: none;
            padding: 20px;
        }

        .table-responsive {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body>

    <div id="loginSection" class="login-box">
        <h4 class="text-center mb-4 text-primary">تسجيل دخول الإدارة</h4>
        <form id="loginForm">
            <input type="email" id="email" class="form-control mb-3" placeholder="البريد الإلكتروني" required>
            <input type="password" id="password" class="form-control mb-3" placeholder="كلمة المرور" required>
            <button type="submit" class="btn btn-primary w-100">دخول</button>
        </form>
    </div>

    <div id="dashboardSection" class="dashboard">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-primary">سجل الحجوزات اليومية</h3>
            <div>
                <button onclick="exportToExcel()" class="btn btn-success"><i class="fas fa-file-excel"></i> تصدير للخبير
                    (Excel)</button>
                <button onclick="logout()" class="btn btn-danger ms-2">خروج</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="exportTable">
                <thead class="table-light">
                    <tr>
                        <th>رقم الدور</th>
                        <th>اسم المريض</th>
                        <th>رقم الهاتف</th>
                        <th>نوع الجهة</th>
                        <th>التخصص</th>
                        <th>الطبيب المعالج</th>
                        <th>تاريخ الحجز</th>
                        <th class="no-print">إجراء</th>
                    </tr>
                </thead>
                <tbody id="bookingsTable">
                    <!-- البيانات ستظهر هنا -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7DEhZdEKyhWtMPMeQ6S6IrDB3lyxJ9DU",
            authDomain: "osretna.firebaseapp.com",
            databaseURL: "https://osretna-default-rtdb.firebaseio.com",
            projectId: "osretna",
            storageBucket: "osretna.firebasestorage.app",
            messagingSenderId: "891601757154",
            appId: "1:891601757154:web:19a8fab19ee8dc3d208fbb",
            measurementId: "G-TCB8XP9C87"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardSection').style.display = 'block';
                loadBookings();
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('dashboardSection').style.display = 'none';
            }
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
                .catch(err => alert("بيانات الدخول غير صحيحة"));
        });

        function loadBookings() {
            const q = query(collection(db, "bookings"), orderBy("dateString", "desc"), orderBy("queueNumber", "asc"));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('bookingsTable');
                tbody.innerHTML = '';
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    tbody.innerHTML += `
                        <tr>
                            <td style="font-weight:bold; color:red;">${data.queueNumber}</td>
                            <td>${data.patientName}</td>
                            <td>${data.phone}</td>
                            <td>${data.type}</td>
                            <td>${data.specialty}</td>
                            <td>${data.doctor}</td>
                            <td>${data.dateString}</td>
                            <td class="no-print"><button onclick="window.del('${docSnap.id}')" class="btn btn-sm btn-outline-danger">حذف</button></td>
                        </tr>
                    `;
                });
            });
        }

        window.del = async (id) => { if (confirm('حذف الحجز؟')) await deleteDoc(doc(db, "bookings", id)); };
        window.logout = () => signOut(auth);
    </script>

    <!-- كود التصدير لملف Excel منظم -->
    <script>
        function exportToExcel() {
            var table = document.getElementById("exportTable");
            var rows = table.rows;
            var csvContent = "\uFEFF"; // لدعم العربية

            for (var i = 0; i < rows.length; i++) {
                var row = [], cols = rows[i].querySelectorAll("td, th");
                // تجاهل العمود الأخير (زر الحذف) عند التصدير
                for (var j = 0; j < cols.length - 1; j++) {
                    // وضع علامات تنصيص لضمان عدم تداخل الأعمدة
                    let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/"/g, '""');
                    row.push('"' + data + '"');
                }
                csvContent += row.join(",") + "\r\n";
            }

            var encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Asfour_Bookings_ExpertSystem.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>

</html>
